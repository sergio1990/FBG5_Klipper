[gcode_macro END_PRINT]
gcode:
    G91
    G1 E-4 F1500
    G1 X5 Y5 Z0.2 F5000
    G1 Z5 F1500
    G90

    M106 S0
    M104 S0
    M140 S0
    BED_MESH_CLEAR

    {% if "xyz" in printer.toolhead.homed_axes %}
      G1 X10 Y210 F5000
    {% endif %}

    M84

[gcode_macro START_PRINT]
description: Ghost 5 start print (smart heat, home, load mesh, purge lines)
# Usage:
#   START_PRINT BED=60 EXTRUDER=210 MESH=default
#   START_PRINT BED=60 EXTRUDER=210 MATERIAL=PLA
gcode:
  {% set bed = params.BED|default(0)|float %}
  {% set extr = params.EXTRUDER|default(0)|float %}
  {% set mesh = params.MESH|default("") %}
  {% set material = params.MATERIAL|default("")|lower %}

  # Standby nozzle temps to prevent oozing during homing
  {% set standby = 160 %}
  {% if material in ["petg", "abs", "asa"] %}
    {% set standby = 170 %}
  {% endif %}

  # Reset overrides
  M220 S100
  M221 S100

  # Coordinate / extrusion modes
  G90
  M82

  # Start heating (non-blocking)
  {% if bed > 0 %}
    M140 S{bed}
  {% endif %}
  {% if extr > 0 %}
    M104 S{standby}     # standby temp during homing
  {% endif %}

  # Home early (while bed is heating)
  G28

  # Wait for bed to reach temperature (bed first)
  {% if bed > 0 %}
    M190 S{bed}
  {% endif %}

  # Re-home Z after bed is hot (more consistent first layer on Ghost 5)
  G28 Z

  # Load bed mesh (safe behavior: if requested missing -> try default, else clear)
  {% if printer.bed_mesh is defined %}
    {% set chosen = "" %}

    {% if mesh|length > 0 %}
      {% set chosen = mesh %}
    {% elif material|length > 0 %}
      {% set chosen = material %}
    {% else %}
      {% set chosen = "default" %}
    {% endif %}

    {% if chosen in printer.bed_mesh.profiles %}
      RESPOND TYPE=echo MSG="Loading bed mesh: {chosen}"
      BED_MESH_PROFILE LOAD={chosen}
    {% elif "default" in printer.bed_mesh.profiles %}
      RESPOND TYPE=echo MSG="Mesh '{chosen}' not found, loading 'default'"
      BED_MESH_PROFILE LOAD=default
    {% else %}
      RESPOND TYPE=echo MSG="No mesh profile found; clearing mesh and continuing"
      BED_MESH_CLEAR
    {% endif %}
  {% endif %}

  # Now heat nozzle to print temp
  {% if extr > 0 %}
    M104 S{extr}
    M109 S{extr}
  {% endif %}

  # Move to purge start safely
  G1 Z5 F1500
  G1 X75 Y5 F5000
  G92 E0

  # Purge lines (your geometry)
  G1 Z0.28 F1500
  G1 E4 F500
  G1 X180 E10 F500
  G1 Y5.4 F5000
  G1 X75 E20 F500
  G1 Z2 F1500
  G92 E0

[gcode_macro TRAM_BED]
description: Heated probe-guided bed tramming (Marlin G35-like workflow)
# Usage examples:
#   TRAM_BED
#   TRAM_BED BED=70 NOZZLE_STANDBY=170
#   TRAM_BED DIRECTION=CCW MAX_DEV=0.08 HMZ=10
# Defaults: BED=60 NOZZLE_STANDBY=160 DIRECTION=CW MAX_DEV=0.03
gcode:
  {% set bed = params.BED|default(60)|float %}
  {% set nozzle_standby = params.NOZZLE_STANDBY|default(160)|float %}
  {% set direction = params.DIRECTION|default("CW")|upper %}
  {% set max_dev = params.MAX_DEV|default(0.03)|float %}
  {% set hmz = params.HMZ|default("") %}

  {% if direction not in ["CW", "CCW"] %}
    {action_raise_error("TRAM_BED: DIRECTION must be CW or CCW")}
  {% endif %}

  G90
  RESPOND TYPE=echo MSG="TRAM_BED: preparing printer for tramming"

  {% if bed > 0 %}
    M140 S{bed}
  {% endif %}
  {% if nozzle_standby > 0 %}
    M104 S{nozzle_standby}
  {% endif %}
  {% if bed > 0 %}
    M190 S{bed}
  {% endif %}

  G28

  {% set cmd = "SCREWS_TILT_CALCULATE DIRECTION=" ~ direction ~ " MAX_DEVIATION=" ~ max_dev %}
  {% if hmz|string|length > 0 %}
    {% set cmd = cmd ~ " HORIZONTAL_MOVE_Z=" ~ (hmz|float) %}
  {% endif %}
  {cmd}

  RESPOND TYPE=echo MSG="TRAM_BED: adjust screws as reported, then rerun TRAM_BED until corrections are near zero."

[gcode_macro TRAM_BED_WIZARD]
description: Step-by-step tramming wizard (one corner at a time, probe-guided)
# Usage examples:
#   TRAM_BED_WIZARD BED=60                ; start wizard at Front-Right
#   TRAM_BED_WIZARD                       ; re-check current corner
#   TRAM_BED_WIZARD NEXT=1                ; advance to next corner
#   TRAM_BED_WIZARD RESET=1               ; exit/reset wizard state
variable_active: 0
variable_corner_index: 2
variable_bed: 60.0
variable_nozzle_standby: 160.0
variable_direction_sign: 1
variable_max_dev: 0.03
variable_hmz: 0.0
gcode:
  {% set state = printer["gcode_macro TRAM_BED_WIZARD"] %}
  {% set reset = params.RESET|default(0)|int %}
  {% set next_step = params.NEXT|default(0)|int %}

  {% if reset == 1 %}
    SET_GCODE_VARIABLE MACRO=TRAM_BED_WIZARD VARIABLE=active VALUE=0
    SET_GCODE_VARIABLE MACRO=TRAM_BED_WIZARD VARIABLE=corner_index VALUE=2
    RESPOND TYPE=echo MSG="TRAM_BED_WIZARD: reset complete."
  {% else %}
    {% if state.active|int == 0 %}
      {% set bed = params.BED|default(60)|float %}
      {% set nozzle_standby = params.NOZZLE_STANDBY|default(160)|float %}
      {% set direction = params.DIRECTION|default("CW")|upper %}
      {% set max_dev = params.MAX_DEV|default(0.03)|float %}
      {% set hmz = params.HMZ|default(0)|float %}

      {% if direction not in ["CW", "CCW"] %}
        {action_raise_error("TRAM_BED_WIZARD: DIRECTION must be CW or CCW")}
      {% endif %}

      {% set direction_sign = 1 %}
      {% if direction == "CCW" %}
        {% set direction_sign = -1 %}
      {% endif %}

      SET_GCODE_VARIABLE MACRO=TRAM_BED_WIZARD VARIABLE=active VALUE=1
      SET_GCODE_VARIABLE MACRO=TRAM_BED_WIZARD VARIABLE=corner_index VALUE=2
      SET_GCODE_VARIABLE MACRO=TRAM_BED_WIZARD VARIABLE=bed VALUE={bed}
      SET_GCODE_VARIABLE MACRO=TRAM_BED_WIZARD VARIABLE=nozzle_standby VALUE={nozzle_standby}
      SET_GCODE_VARIABLE MACRO=TRAM_BED_WIZARD VARIABLE=direction_sign VALUE={direction_sign}
      SET_GCODE_VARIABLE MACRO=TRAM_BED_WIZARD VARIABLE=max_dev VALUE={max_dev}
      SET_GCODE_VARIABLE MACRO=TRAM_BED_WIZARD VARIABLE=hmz VALUE={hmz}

      {% if bed > 0 %}
        M140 S{bed}
      {% endif %}
      {% if nozzle_standby > 0 %}
        M104 S{nozzle_standby}
      {% endif %}
      {% if bed > 0 %}
        M190 S{bed}
      {% endif %}

      G28

      {% set corner = 2 %}
      {% set run_direction_sign = direction_sign %}
      {% set run_max_dev = max_dev %}
      {% set run_hmz = hmz %}
    {% else %}
      {% set corner = state.corner_index|int %}
      {% if next_step == 1 %}
        {% set corner = corner + 1 %}
      {% endif %}

      {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
      {% endif %}

      {% set run_direction_sign = state.direction_sign|int %}
      {% set run_max_dev = state.max_dev|float %}
      {% set run_hmz = state.hmz|float %}
    {% endif %}

    {% if corner > 4 %}
      SET_GCODE_VARIABLE MACRO=TRAM_BED_WIZARD VARIABLE=active VALUE=0
      SET_GCODE_VARIABLE MACRO=TRAM_BED_WIZARD VARIABLE=corner_index VALUE=2
      RESPOND TYPE=echo MSG="TRAM_BED_WIZARD: completed all corners. Next: PROBE_CALIBRATE, BED_MESH_CALIBRATE, SAVE_CONFIG."
    {% else %}
      SET_GCODE_VARIABLE MACRO=TRAM_BED_WIZARD VARIABLE=corner_index VALUE={corner}

      {% set direction = "CW" %}
      {% if run_direction_sign < 0 %}
        {% set direction = "CCW" %}
      {% endif %}

      {% set cmd = "SCREWS_TILT_CALCULATE DIRECTION=" ~ direction %}
      {% if run_max_dev > 0 %}
        {% set cmd = cmd ~ " MAX_DEVIATION=" ~ run_max_dev %}
      {% endif %}
      {% if run_hmz > 0 %}
        {% set cmd = cmd ~ " HORIZONTAL_MOVE_Z=" ~ run_hmz %}
      {% endif %}
      {cmd}

      {% set move_z = 7.0 %}
      {% if run_hmz > 0 %}
        {% set move_z = run_hmz %}
      {% endif %}

      {% set corner_name = "Front-Right" %}
      {% set move_x = 190 %}
      {% set move_y = 35 %}
      {% if corner == 3 %}
        {% set corner_name = "Back-Right" %}
        {% set move_x = 190 %}
        {% set move_y = 185 %}
      {% elif corner == 4 %}
        {% set corner_name = "Back-Left" %}
        {% set move_x = 0 %}
        {% set move_y = 185 %}
      {% endif %}

      G90
      G1 Z{move_z} F900
      G1 X{move_x} Y{move_y} F5000
      RESPOND TYPE=echo MSG="TRAM_BED_WIZARD: adjust {corner_name} using output above, then run TRAM_BED_WIZARD to re-check this corner or TRAM_BED_WIZARD NEXT=1 to continue."
    {% endif %}
  {% endif %}

[gcode_macro CASE_LIGHT_ON]
description: Turn case light on
gcode:
  SET_PIN PIN=case_light VALUE=1

[gcode_macro CASE_LIGHT_OFF]
description: Turn case light off
gcode:
  SET_PIN PIN=case_light VALUE=0

[gcode_macro CASE_LIGHT_TOGGLE]
description: Toggle case light state
gcode:
  {% set current = printer["output_pin case_light"].value|default(0)|float %}
  {% if current >= 0.5 %}
    CASE_LIGHT_OFF
  {% else %}
    CASE_LIGHT_ON
  {% endif %}
