[gcode_macro END_PRINT]
gcode:
    G91
    G1 E-4 F1500
    G1 X5 Y5 Z0.2 F5000
    G1 Z5 F1500
    G90

    M106 S0
    M104 S0
    M140 S0
    BED_MESH_CLEAR

    {% if "xyz" in printer.toolhead.homed_axes %}
      G1 X10 Y210 F5000
    {% endif %}

    M84

[gcode_macro START_PRINT]
description: Ghost 5 start print (smart heat, home, load mesh, purge lines)
# Usage:
#   START_PRINT BED=60 EXTRUDER=210 MESH=default
#   START_PRINT BED=60 EXTRUDER=210 MATERIAL=PLA
gcode:
  {% set bed = params.BED|default(0)|float %}
  {% set extr = params.EXTRUDER|default(0)|float %}
  {% set mesh = params.MESH|default("") %}
  {% set material = params.MATERIAL|default("")|lower %}

  # Standby nozzle temps to prevent oozing during homing
  {% set standby = 160 %}
  {% if material in ["petg", "abs", "asa"] %}
    {% set standby = 170 %}
  {% endif %}

  # Reset overrides
  M220 S100
  M221 S100

  # Coordinate / extrusion modes
  G90
  M82

  # Start heating (non-blocking)
  {% if bed > 0 %}
    M140 S{bed}
  {% endif %}
  {% if extr > 0 %}
    M104 S{standby}     # standby temp during homing
  {% endif %}

  # Home early (while bed is heating)
  G28

  # Wait for bed to reach temperature (bed first)
  {% if bed > 0 %}
    M190 S{bed}
  {% endif %}

  # Re-home Z after bed is hot (more consistent first layer on Ghost 5)
  G28 Z

  # Load bed mesh (safe behavior: if requested missing -> try default, else clear)
  {% if printer.bed_mesh is defined %}
    {% set chosen = "" %}

    {% if mesh|length > 0 %}
      {% set chosen = mesh %}
    {% elif material|length > 0 %}
      {% set chosen = material %}
    {% else %}
      {% set chosen = "default" %}
    {% endif %}

    {% if chosen in printer.bed_mesh.profiles %}
      RESPOND TYPE=echo MSG="Loading bed mesh: {chosen}"
      BED_MESH_PROFILE LOAD={chosen}
    {% elif "default" in printer.bed_mesh.profiles %}
      RESPOND TYPE=echo MSG="Mesh '{chosen}' not found, loading 'default'"
      BED_MESH_PROFILE LOAD=default
    {% else %}
      RESPOND TYPE=echo MSG="No mesh profile found; clearing mesh and continuing"
      BED_MESH_CLEAR
    {% endif %}
  {% endif %}

  # Now heat nozzle to print temp
  {% if extr > 0 %}
    M104 S{extr}
    M109 S{extr}
  {% endif %}

  # Move to purge start safely
  G1 Z5 F1500
  G1 X75 Y5 F5000
  G92 E0

  # Purge lines (your geometry)
  G1 Z0.28 F1500
  G1 E4 F500
  G1 X180 E10 F500
  G1 Y5.4 F5000
  G1 X75 E20 F500
  G1 Z2 F1500
  G92 E0